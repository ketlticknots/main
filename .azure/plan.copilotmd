# Azure Deployment Plan for main Project
## **Goal**
Deploy the main project (TypeScript/Next.js and JavaScript modules) to Azure using AZD.

## **Project Information**
**AppName:** main
- **Stack:** Next.js (TypeScript), JavaScript
- **Type:** Monorepo web app
- **Containerization:** No Dockerfile detected
- **Dependencies:** None detected
- **Hosting:** Azure App Service

## **Azure Resources Architecture**
```mermaid
graph TD
%% Services
svcazureappservice_frontend["`Name: frontend\nPath: frontend\nLanguage: ts`"]
svcazureappservice_main["`Name: main\nPath: main\nLanguage: js`"]
subgraph "Compute Resources"
%% Resources
azureappservice_frontend("`frontend (Azure App Service)`")
azureappservice_main("`main (Azure App Service)`")
end
%% Relationships
svcazureappservice_frontend --> |"hosted on"| azureappservice_frontend
svcazureappservice_main --> |"hosted on"| azureappservice_main
```
- The frontend and main modules are hosted independently on Azure App Service.

## **Recommended Azure Resources**
Application frontend:
- Hosting Service Type: Azure App Service
- SKU: Standard (S1) // Good for production workloads, scalable
- Configuration:
    - language: nodejs
    - Environment Variables: []
- Dependencies Resource: None

Application main:
- Hosting Service Type: Azure App Service
- SKU: Standard (S1)
- Configuration:
    - language: nodejs
    - Environment Variables: []
- Dependencies Resource: None

## **Recommended Supporting Services**:
- Application Insights
- User-Assigned Managed Identity
- Log Analytics Workspace: set all app service to connect to this

## **Recommended Security Configurations**:
- User-Assigned Managed Identity must have permissions into the Key Vault (if used).
- User-Assigned Managed Identity must be assigned to all supported resources

## **Execution Step**
Execution Steps:
1. Create Azure Infrastructure Files for AZD:
    1. Provisioning tool: AZD. Expected files: undefined
    2. Grab current subscriptionID, call tool `appmod-get-available-region-sku` to get available region and SKUs for all needed Azure resource types. 
    3. If expected files exist, please follow the below steps:
        - Existing file paths: <filePaths>
        - Check if the Azure resources in the existing files match what we required in the plan. If not, add steps to update the existing files with missing Azure resource.
        - Generating Files: No
    4. If expected files do not exist, please follow the below steps:
        - Generate the missing expected files, call tool `appmod-get-iac-rules` to get the rules for file generation.
        - Call `get_errors` on the generated files and iterate on any errors.
        - Generating Files: undefined
    5. Fix the  files and retry if there's any error in the provisioning files. Use `get_errors` tool if available to help look for errors.
2. Env setup for azd:
    1. Install AZ CLI and AZD if not installed.
    2. Run 'azd env new <envName> --no-prompt' to create a new environment, generating a name for the user. If there's existing environment, check if the environment matches the requirements.
    3. Review infra/main.tf, infra/variables.tf, infra/terraform.tfvars.json for environment variables. Set these for the user using azd env set <key> <value>. Use default values (from AZ CLI) if not provided by the user. Subscription ID is always required.
    4. Set the subscription: Use default subscription
    5. Set AZURE_RESOURCE_GROUP environment variable. The region of the resource group does not have to match its inner resources.
3. Deployment:
    1. Run `azd provision --preview --no-prompt` to dry run your infrastructure and confirm everything is well-formed.
    2. Azd App Deployment:
        1. Run `azd up --no-prompt`. Iterate on any errors, and retry.
    3. Deployment Validation:
        1. Check the application log with tool `appmod-get-azd-app-logs` to ensure the services are running.
4. Summarize Deployment Result:
    1. Use `appmod-summarize-result` tool to summarize the deployment result.
    2. Generating files: .azure/summary.copilotmd

## **Progress Tracking**
- Copilot must create and update `.azure/progress.copilotmd` after each step.  
- Progress should include:  
  - ‚úÖ Completed tasks  
  - üî≤ Pending tasks  
  - ‚ùå Failed tasks with error notes
If a script fails, log the error, regenerate/fix the script, and retry until the step completes.  
- Example format:
- [x] Containerization complete (Dockerfile found at ./Dockerfile)
- [] Deployment in progress
  - Attempt 1 failed: ACR push error (unauthorized).
  - Fixed by regenerating deploy script with correct az acr login. Retrying...

## **Tools Checklist**
- Copilot MUST call the following tools as specified in the Execution Step. Mark tools complete when called. Do not make substitutions.
- [] appmod-get-available-region-sku
- [] appmod-get-iac-rules
- [] appmod-summarize-result
