<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" />
  <title>Convert Clover Coins ‚Üí L2 Token - TradeHax</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" integrity="sha512-wnea99uKIC3TJF7v4eKk4Y+lMz2Mklv18+r4na2Gn1abDRPPOeef95xTzdwGD9e6zXJBteMIhZ1+68QC5byJZw==" crossorigin="anonymous" />
  <style>
    body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; }
  </style>
</head>
<body class="text-white">
  <div class="max-w-3xl mx-auto p-6">
    <div class="flex items-start justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold">üçÄ Convert Clover Coins</h1>
        <p class="text-gray-300">Swap your earned coins into our upcoming L2 token.</p>
      </div>
      <div id="wallet-container"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="p-4 rounded-lg bg-black bg-opacity-40 border border-green-500/30">
        <div class="text-sm text-gray-400">Total Coins</div>
        <div class="text-3xl font-bold text-green-400">‚òòÔ∏è <span id="conv-total">0</span></div>
      </div>
      <div class="p-4 rounded-lg bg-black bg-opacity-40 border border-yellow-500/30">
        <div class="text-sm text-gray-400">Pending (Unclaimed)</div>
        <div class="text-3xl font-bold text-yellow-300">‚òòÔ∏è <span id="conv-pending">0</span></div>
      </div>
      <div class="p-4 rounded-lg bg-black bg-opacity-40 border border-blue-500/30">
        <div class="text-sm text-gray-400">Session Earned</div>
        <div class="text-3xl font-bold text-blue-300">‚òòÔ∏è <span id="conv-session">0</span></div>
      </div>
    </div>

    <div class="p-6 rounded-lg bg-black bg-opacity-40 border border-green-500/30">
      <h2 class="text-xl font-bold mb-4">Convert</h2>
      <div class="flex flex-col md:flex-row gap-4 items-center">
        <input id="conv-amount" type="number" min="0" step="1" placeholder="Amount to convert" class="w-full md:w-64 px-4 py-2 rounded bg-gray-900 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" />
        <div class="flex gap-2">
          <button id="conv-max" class="px-3 py-2 rounded bg-gray-800 border border-gray-600 hover:bg-gray-700">Max</button>
          <button id="conv-pending-btn" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 font-semibold">Convert Pending</button>
        </div>
      </div>
      <div id="conv-status" class="text-sm text-gray-300 mt-3"></div>
      <p class="text-xs text-gray-400 mt-2">Note: If a backend `CLAIM_API_BASE` is configured, we will submit a signed claim. Otherwise, we simulate a Devnet claim.</p>
    </div>

    <div class="mt-8 text-sm text-gray-400">
      <a href="/games/" class="text-green-400 hover:text-green-300">‚Üê Back to Games</a>
    </div>
  </div>

  <script src="web3-rewards.js"></script>
  <script>
    let rewards;
    let isProcessing = false;

    function update() {
      const s = rewards.getStats();
      document.getElementById('conv-total').textContent = s.totalCoins;
      document.getElementById('conv-pending').textContent = s.pendingCoins;
      document.getElementById('conv-session').textContent = s.sessionCoins || 0;
      
      // Update max button and validation based on pending coins
      const maxBtn = document.getElementById('conv-max');
      maxBtn.textContent = `Max (${s.pendingCoins})`;
    }

    function setStatus(msg, cls = 'text-gray-300') {
      const el = document.getElementById('conv-status');
      el.textContent = msg;
      el.className = `text-sm mt-3 ${cls}`;
    }

    function validateAmount(amountStr) {
      if (!amountStr || amountStr.trim() === '') {
        return { valid: false, error: 'Please enter an amount' };
      }

      const amt = parseFloat(amountStr);
      
      if (!Number.isFinite(amt)) {
        return { valid: false, error: 'Amount must be a valid number' };
      }

      if (amt < 0) {
        return { valid: false, error: 'Amount cannot be negative' };
      }

      if (!Number.isInteger(amt)) {
        return { valid: false, error: 'Amount must be a whole number' };
      }

      const s = rewards.getStats();
      if (amt === 0) {
        return { valid: false, error: 'Amount must be greater than 0' };
      }

      if (amt > s.pendingCoins) {
        return { valid: false, error: `Amount exceeds pending balance (${s.pendingCoins})` };
      }

      return { valid: true, amount: Math.floor(amt) };
    }

    document.addEventListener('DOMContentLoaded', () => {
      rewards = new Web3RewardsSystem('convert');
      rewards.initWalletUI('wallet-container');
      update();

      const amountInput = document.getElementById('conv-amount');

      // Real-time validation feedback
      amountInput.addEventListener('input', () => {
        const val = amountInput.value.trim();
        if (!val) {
          amountInput.classList.remove('border-red-500', 'border-green-500');
          setStatus('');
          return;
        }

        const validation = validateAmount(val);
        if (validation.valid) {
          amountInput.classList.remove('border-red-500');
          amountInput.classList.add('border-green-500');
          setStatus(`Ready to convert ${validation.amount} coins`, 'text-green-400');
        } else {
          amountInput.classList.remove('border-green-500');
          amountInput.classList.add('border-red-500');
          setStatus(validation.error, 'text-red-400');
        }
      });

      document.getElementById('conv-max').addEventListener('click', () => {
        const s = rewards.getStats();
        amountInput.value = s.pendingCoins;
        amountInput.dispatchEvent(new Event('input'));
      });

      document.getElementById('conv-pending-btn').addEventListener('click', async () => {
        if (isProcessing) {
          setStatus('Request already processing...', 'text-yellow-400');
          return;
        }

        const validation = validateAmount(amountInput.value);
        if (!validation.valid) {
          setStatus(validation.error, 'text-red-400');
          amountInput.focus();
          return;
        }

        isProcessing = true;
        const convertBtn = document.getElementById('conv-pending-btn');
        const originalText = convertBtn.textContent;
        convertBtn.disabled = true;

        try {
          if (window.CLAIM_API_BASE) {
            setStatus('Submitting conversion...', 'text-blue-300');
            await rewards.claimViaApi(validation.amount);
          } else {
            setStatus('Claiming on Devnet (simulation)...', 'text-blue-300');
            await rewards.claimRewards();
          }
          update();
          amountInput.value = '';
          amountInput.classList.remove('border-red-500', 'border-green-500');
          setStatus('‚úì Conversion complete! Check your wallet.', 'text-green-400');
        } catch (e) {
          console.error(e);
          setStatus(`‚úó Conversion failed: ${e.message || e}`, 'text-red-400');
        } finally {
          isProcessing = false;
          convertBtn.disabled = false;
          convertBtn.textContent = originalText;
        }
      });

      setInterval(update, 1500);
    });
  </script>
</body>
</html>
